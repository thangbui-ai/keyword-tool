<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO & Amazon AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f1f5f9; }
        .glass-card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); overflow: hidden; }
        textarea { resize: vertical; min-height: 80px; }
        .output-box { 
            background-color: #f8fafc; 
            border: 1px dashed #e2e8f0; 
            border-radius: 6px; 
            padding: 10px; 
            font-size: 0.85rem; 
            color: #334155;
            min-height: 60px;
            white-space: pre-wrap;
            position: relative;
            word-break: break-all;
            outline: none;
            transition: border-color 0.2s;
        }
        .output-box:focus {
            border: 1px solid #3b82f6;
            background-color: #fff;
        }
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            display: none;
            z-index: 10;
        }
        .bullet-label { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 2px; display: block; }
        
        mark.keyword-highlight {
            background-color: #fde047; 
            color: #000;
            padding: 1px 2px;
            border-radius: 2px;
            font-weight: 600;
        }

        .title-input { font-size: 11px; padding: 4px 8px; border: 1px solid #e2e8f0; border-radius: 4px; width: 100%; outline: none; }
        .title-input:focus { border-color: #10b981; }
        .html-view { font-family: 'Courier New', Courier, monospace; color: #065f46; }
        
        .kw-tag { 
            display: inline-flex; 
            align-items: center; 
            font-size: 10px; 
            padding: 2px 6px; 
            border-radius: 4px; 
            margin: 2px; 
            font-weight: 600;
            border-width: 1px;
        }
        .kw-found { background-color: #f0fdf4; color: #166534; border-color: #bbf7d0; }
        .kw-missing { background-color: #fef2f2; color: #991b1b; border-color: #fecaca; }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="max-w-6xl mx-auto space-y-6">
        
        <!-- Header & API Key -->
        <header class="glass-card p-6 border-b-4 border-blue-500">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800"><i class="fas fa-bolt text-yellow-500 mr-2"></i>AI Content Lab</h1>
                    <p class="text-xs text-slate-500 font-medium text-slate-400">Chế độ: Chỉnh sửa trực tiếp & Đối soát từ khóa</p>
                </div>
                <div class="flex flex-col gap-2 w-full md:w-auto">
                    <div class="flex gap-2">
                        <input type="password" id="apiKey" placeholder="Dán OpenAI API Key..." class="w-full md:w-64 p-2 text-sm border rounded focus:ring-2 focus:ring-blue-400 outline-none">
                        <button onclick="saveApiKey()" title="Lưu Key" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm transition-all shadow-sm"><i class="fas fa-save"></i></button>
                        <button onclick="deleteApiKey()" title="Xóa Key" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm transition-all shadow-sm"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 gap-6">
            
            <!-- 1. Định dạng từ khóa -->
            <section class="glass-card p-5 border-l-4 border-slate-500">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="font-bold text-slate-700 uppercase text-sm tracking-wider">1. Định dạng từ khóa</h2>
                    <div id="stat-keyword" class="text-[10px] font-bold text-slate-400 uppercase">0 Ký tự</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <textarea id="keywordInput" placeholder="Nhập từ khóa (mỗi dòng 1 từ)..." class="w-full p-3 border rounded-lg focus:border-blue-400 outline-none text-sm"></textarea>
                        <button onclick="formatOnly()" class="w-full mt-2 bg-slate-800 hover:bg-black text-white py-2 rounded-lg text-sm font-bold transition-all">
                            Xử lý dấu ";"
                        </button>
                    </div>
                    <div class="relative">
                        <div id="out-keyword" contenteditable="true" oninput="updateStats('keyword')" class="output-box h-full">...</div>
                        <button onclick="copyRawText('out-keyword')" class="absolute top-2 right-2 text-slate-400 hover:text-blue-500"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
            </section>

            <!-- 2. Amazon Bullet Points -->
            <section class="glass-card p-5 border-l-4 border-green-500">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="font-bold text-slate-700 uppercase text-sm tracking-wider">2. Amazon Bullet Points (Có thể sửa)</h2>
                    <button onclick="copyAllBullets()" class="text-[10px] font-bold text-blue-600 hover:underline uppercase">Copy All Bullets</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <label class="text-[10px] font-bold text-slate-500 uppercase">Tên sản phẩm (___)</label>
                            <input type="text" id="prodBullets" placeholder="Tên sản phẩm..." class="w-full p-2 border rounded text-sm outline-none focus:border-green-400 mt-1">
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Cấu trúc 5 Titles</label>
                            <div class="grid grid-cols-1 gap-2">
                                <input type="text" id="title-0" value="Name of the product" class="title-input">
                                <input type="text" id="title-1" value="Set Include" class="title-input">
                                <input type="text" id="title-2" value="Gift Idea" class="title-input">
                                <input type="text" id="title-3" value="High Quality" class="title-input">
                                <input type="text" id="title-4" value="Careful Packaging" class="title-input">
                            </div>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <label class="text-[10px] font-bold text-slate-500 uppercase">Từ khóa chính</label>
                            <textarea id="keyBullets" oninput="updateChecklist('bullets')" placeholder="Dán danh sách từ khóa..." class="w-full p-2 border rounded text-sm outline-none focus:border-green-400 mt-1"></textarea>
                            <div id="check-bullets" class="mt-2 flex flex-wrap min-h-[20px]"></div>
                        </div>
                        <button onclick="generateAI('bullets')" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold shadow-md transition-all text-sm">
                            <i class="fas fa-feather-alt mr-2"></i>Tạo 5 Bullets
                        </button>
                    </div>
                    <div class="relative space-y-3">
                        <div id="load-bullets" class="loading-overlay"><i class="fas fa-spinner fa-spin text-green-500 text-2xl"></i></div>
                        <div class="space-y-3" id="bulletContainer">
                            <!-- Editable Output Boxes -->
                            <div class="bullet-item">
                                <span class="bullet-label" id="label-bullet-0">Bullet 1</span>
                                <div class="relative">
                                    <div id="out-bullet-0" contenteditable="true" oninput="updateStats('bullets', 0)" class="output-box">...</div>
                                    <div class="flex justify-between mt-1 text-[9px] font-bold uppercase">
                                        <span id="stat-bullet-0" class="text-slate-400">0 Ký tự</span>
                                        <button onclick="copyRawText('out-bullet-0')" class="text-blue-400 hover:text-blue-600">Copy</button>
                                    </div>
                                </div>
                            </div>
                            <div class="bullet-item">
                                <span class="bullet-label" id="label-bullet-1">Bullet 2</span>
                                <div class="relative">
                                    <div id="out-bullet-1" contenteditable="true" oninput="updateStats('bullets', 1)" class="output-box">...</div>
                                    <div class="flex justify-between mt-1 text-[9px] font-bold uppercase">
                                        <span id="stat-bullet-1" class="text-slate-400">0 Ký tự</span>
                                        <button onclick="copyRawText('out-bullet-1')" class="text-blue-400 hover:text-blue-600">Copy</button>
                                    </div>
                                </div>
                            </div>
                            <div class="bullet-item">
                                <span class="bullet-label" id="label-bullet-2">Bullet 3</span>
                                <div class="relative">
                                    <div id="out-bullet-2" contenteditable="true" oninput="updateStats('bullets', 2)" class="output-box">...</div>
                                    <div class="flex justify-between mt-1 text-[9px] font-bold uppercase"><span id="stat-bullet-2" class="text-slate-400">0 Ký tự</span><button onclick="copyRawText('out-bullet-2')" class="text-blue-400 hover:text-blue-600">Copy</button></div>
                                </div>
                            </div>
                            <div class="bullet-item"><span class="bullet-label" id="label-bullet-3">Bullet 4</span><div class="relative"><div id="out-bullet-3" contenteditable="true" oninput="updateStats('bullets', 3)" class="output-box">...</div><div class="flex justify-between mt-1 text-[9px] font-bold uppercase"><span id="stat-bullet-3" class="text-slate-400">0 Ký tự</span><button onclick="copyRawText('out-bullet-3')" class="text-blue-400 hover:text-blue-600">Copy</button></div></div></div>
                            <div class="bullet-item"><span class="bullet-label" id="label-bullet-4">Bullet 5</span><div class="relative"><div id="out-bullet-4" contenteditable="true" oninput="updateStats('bullets', 4)" class="output-box">...</div><div class="flex justify-between mt-1 text-[9px] font-bold uppercase"><span id="stat-bullet-4" class="text-slate-400">0 Ký tự</span><button onclick="copyRawText('out-bullet-4')" class="text-blue-400 hover:text-blue-600">Copy</button></div></div></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. Amazon HTML Description -->
            <section class="glass-card p-5 border-l-4 border-emerald-500">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="font-bold text-slate-700 uppercase text-sm tracking-wider">3. Amazon Description (Có thể sửa HTML)</h2>
                    <div id="stat-desc" class="text-[10px] font-bold text-emerald-500 uppercase">0/1000 Bytes</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-3">
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <label class="text-[10px] font-bold text-slate-500 uppercase">Sản phẩm (___)</label>
                            <input type="text" id="prodDesc" placeholder="Tên sản phẩm..." class="w-full p-2 border rounded mt-1 text-sm outline-none focus:border-emerald-400">
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <label class="text-[10px] font-bold text-slate-500 uppercase">Từ khóa (...)</label>
                            <textarea id="keyDesc" oninput="updateChecklist('description')" placeholder="Dán danh sách từ khóa..." class="w-full p-2 border rounded mt-1 text-sm outline-none focus:border-emerald-400"></textarea>
                            <div id="check-desc" class="mt-2 flex flex-wrap min-h-[20px]"></div>
                        </div>
                        <button onclick="generateAI('description')" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-2.5 rounded-lg font-bold shadow-md transition-all text-sm">
                            <i class="fas fa-code mr-2"></i>Tạo mã HTML
                        </button>
                    </div>
                    <div class="relative">
                        <div id="out-desc" contenteditable="true" oninput="updateStats('description')" class="output-box h-full font-mono text-[11px] html-view overflow-x-auto">...</div>
                        <div id="load-desc" class="loading-overlay"><i class="fas fa-spinner fa-spin text-emerald-500 text-xl"></i></div>
                        <button onclick="copyRawText('out-desc')" class="absolute top-2 right-2 text-slate-400 hover:text-emerald-500"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
            </section>
        </div>

        <footer class="text-center text-slate-400 text-[10px] pb-6">
            Sửa thủ công: Bảng đối soát và bộ đếm sẽ tự động cập nhật
        </footer>
    </div>

    <script>
        window.onload = function() {
            const savedKey = localStorage.getItem('amazon_tool_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                updateStatus(true);
            }
        };

        function updateStatus(isSaved) {
            const status = document.getElementById('keyStatus');
            status.innerText = isSaved ? "API Key: Đã kết nối" : "API Key: Chưa thiết lập";
            status.className = isSaved ? "text-[10px] text-right text-green-500 font-bold" : "text-[10px] text-right text-slate-400 italic";
        }

        function saveApiKey() {
            const key = document.getElementById('apiKey').value;
            if(!key) return alert("Nhập Key!");
            localStorage.setItem('amazon_tool_key', key);
            updateStatus(true);
            alert("Đã lưu API Key!");
        }

        function deleteApiKey() {
            localStorage.removeItem('amazon_tool_key');
            document.getElementById('apiKey').value = "";
            updateStatus(false);
            alert("Đã xóa Key!");
        }

        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        function highlightKeywords(escapedContent, keywordString) {
            if (!escapedContent || !keywordString) return escapedContent;
            const keywords = keywordString.split(/[;,\n]/)
                .map(k => k.trim())
                .filter(k => k.length > 1) 
                .sort((a, b) => b.length - a.length);

            if (keywords.length === 0) return escapedContent;
            
            let result = escapedContent;
            keywords.forEach(kw => {
                const escapedKw = escapeHtml(kw);
                const pattern = new RegExp(`(?![^<]*>)(${escapedKw})`, 'gi');
                result = result.replace(pattern, `<mark class="keyword-highlight">$1</mark>`);
            });
            return result;
        }

        // Cập nhật thông số khi người dùng tự sửa
        function updateStats(type, index = null) {
            if (type === 'keyword') {
                const text = document.getElementById('out-keyword').innerText;
                document.getElementById('stat-keyword').innerText = `${text.length} Ký tự`;
            } else if (type === 'bullets') {
                const el = document.getElementById(`out-bullet-${index}`);
                const text = el.innerText;
                const statEl = document.getElementById(`stat-bullet-${index}`);
                statEl.innerText = `${text.length} Ký tự`;
                statEl.className = text.length > 250 ? "text-red-500 font-bold" : "text-slate-400";
                updateChecklist('bullets');
            } else if (type === 'description') {
                const text = document.getElementById('out-desc').innerText;
                const bytes = new TextEncoder().encode(text).length;
                const statEl = document.getElementById('stat-desc');
                statEl.innerText = `${bytes}/1000 Bytes`;
                statEl.className = bytes > 1000 ? "text-[10px] font-bold text-red-600 uppercase" : "text-[10px] font-bold text-emerald-500 uppercase";
                updateChecklist('description');
            }
        }

        function updateChecklist(type) {
            let inputId = type === 'bullets' ? 'keyBullets' : 'keyDesc';
            let checkId = type === 'bullets' ? 'check-bullets' : 'check-desc';
            let keywordsText = document.getElementById(inputId).value;
            let checkContainer = document.getElementById(checkId);

            if (!keywordsText) {
                checkContainer.innerHTML = "";
                return;
            }

            let outputText = "";
            if (type === 'bullets') {
                for (let i = 0; i < 5; i++) {
                    outputText += document.getElementById(`out-bullet-${i}`).innerText + " ";
                }
            } else {
                outputText = document.getElementById('out-desc').innerText;
            }

            const keywords = keywordsText.split(/[;,\n]/)
                .map(k => k.trim())
                .filter(k => k.length > 0);

            checkContainer.innerHTML = "";
            keywords.forEach(kw => {
                const found = outputText.toLowerCase().includes(kw.toLowerCase());
                const span = document.createElement('span');
                span.className = `kw-tag ${found ? 'kw-found' : 'kw-missing'}`;
                span.innerHTML = `<i class="fas ${found ? 'fa-check' : 'fa-times'} mr-1"></i>${kw}`;
                checkContainer.appendChild(span);
            });
        }

        function formatOnly() {
            const input = document.getElementById('keywordInput').value;
            if(!input) return;
            const lines = input.split('\n').filter(line => line.trim() !== "");
            const result = lines.join('; ');
            const outBox = document.getElementById('out-keyword');
            outBox.innerText = result; 
            updateStats('keyword');
        }

        async function generateAI(type) {
            const apiKey = localStorage.getItem('amazon_tool_key');
            if (!apiKey) return alert("Vui lòng lưu API Key trước!");

            let prod, keys, prompt, loadId;
            
            if(type === 'bullets') {
                prod = document.getElementById('prodBullets').value;
                keys = document.getElementById('keyBullets').value;
                const titles = [0,1,2,3,4].map(i => document.getElementById(`title-${i}`).value);
                loadId = 'load-bullets';
                if(!prod || !keys) return alert("Nhập đủ thông tin!");
                
                prompt = `Write 5 Amazon bullet points for: ${prod}. Keywords to use: ${keys}.
                Titles: 1. ${titles[0]}, 2. ${titles[1]}, 3. ${titles[2]}, 4. ${titles[3]}, 5. ${titles[4]}.
                STRICT RULES:
                - Use ALL keywords. Max 250 chars per bullet.
                - Start EACH string with Title followed by colon.
                - NO quotation marks. NO trailing commas.
                - Return ONLY a JSON array of 5 plain strings.`;
                
                titles.forEach((t, i) => document.getElementById(`label-bullet-${i}`).innerText = t);
            } else {
                prod = document.getElementById('prodDesc').value;
                keys = document.getElementById('keyDesc').value;
                loadId = 'load-desc';
                if(!prod || !keys) return alert("Nhập đủ thông tin!");

                prompt = `Write an Amazon description in HTML for: ${prod}. Keywords: ${keys}.
                RULES: Target 800 bytes. Use <p>, <b>, <br> only. Wrap ALL keywords in <b>. Return ONLY HTML.`;
            }

            document.getElementById(loadId).style.display = 'flex';

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.1 
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                let resultText = data.choices[0].message.content;
                resultText = resultText.replace(/```html|```/g, "").trim();

                if(type === 'bullets') {
                    handleBulletResponse(resultText, keys);
                } else {
                    const outId = 'out-desc';
                    document.getElementById(outId).innerHTML = highlightKeywords(escapeHtml(resultText), keys);
                    updateStats('description');
                }
                updateChecklist(type);
            } catch (error) {
                alert("Lỗi: " + error.message);
            } finally {
                document.getElementById(loadId).style.display = 'none';
            }
        }

        function handleBulletResponse(text, keywordStr) {
            try {
                const cleanText = text.replace(/```json|```/g, "").trim();
                let bullets = JSON.parse(cleanText);
                bullets.forEach((content, index) => {
                    if(index < 5) {
                        let formatted = content.trim().replace(/^["']+|["',]+$/g, "");
                        formatted = formatted.charAt(0).toUpperCase() + formatted.slice(1);
                        const outBox = document.getElementById(`out-bullet-${index}`);
                        outBox.innerHTML = highlightKeywords(escapeHtml(formatted), keywordStr);
                        updateStats('bullets', index);
                    }
                });
            } catch (e) {
                const lines = text.split('\n').filter(l => l.trim().length > 5);
                lines.forEach((l, i) => {
                    if(i < 5) {
                        let formatted = l.trim().replace(/^["']+|["',]+$/g, "");
                        formatted = formatted.charAt(0).toUpperCase() + formatted.slice(1);
                        document.getElementById(`out-bullet-${i}`).innerHTML = highlightKeywords(escapeHtml(formatted), keywordStr);
                        updateStats('bullets', i);
                    }
                });
            }
        }

        function copyAllBullets() {
            let allText = "";
            for(let i=0; i<5; i++) {
                const el = document.getElementById(`out-bullet-${i}`);
                allText += el.innerText + "\n";
            }
            const temp = document.createElement('textarea');
            document.body.appendChild(temp);
            temp.value = allText.trim();
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            alert("Đã copy 5 bullets!");
        }

        function copyRawText(id) {
            const el = document.getElementById(id);
            const text = el.innerText;
            if(!text || text === "...") return;
            const temp = document.createElement('textarea');
            document.body.appendChild(temp);
            temp.value = text;
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            const btn = event.currentTarget;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<span class="text-[8px] text-blue-500">Copied!</span>';
            setTimeout(() => btn.innerHTML = originalHTML, 1500);
        }
    </script>
</body>
</html>
